"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RobulaPlusOptions=exports.XPath=exports.RobulaPlus=void 0;class RobulaPlus{constructor(e){this.attributePriorizationList=["name","class","title","alt","value"],this.attributeBlackList=["href","src","onclick","onload","tabindex","width","height","style","size","maxlength"],e&&(this.attributePriorizationList=e.attributePriorizationList,this.attributeBlackList=e.attributeBlackList)}getRobustXPath(e,n){if(!n.body.contains(e))throw new Error("Document does not contain given element!");const t=[new XPath("//*")];for(;t.length>0;){const o=t.shift();let s=[];s=s.concat(this.transfConvertStar(o,e)),s=s.concat(this.transfAddId(o,e)),s=s.concat(this.transfAddText(o,e)),s=s.concat(this.transfAddAttribute(o,e)),s=s.concat(this.transfAddAttributeSet(o,e)),s=s.concat(this.transfAddPosition(o,e)),s=s.concat(this.transfAddLevel(o,e)),s=[...new Set(s)];for(const o of s){if(this.uniquelyLocate(o.getValue(),e,n))return o.getValue();t.push(o)}}throw new Error("Internal Error: xPathList.shift returns undefined")}getElementByXPath(t,e){return e.evaluate(t,e,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}uniquelyLocate(n,s,e){const t=e.evaluate(n,e,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);return t.snapshotLength===1&&t.snapshotItem(0)===s}transfConvertStar(e,n){const t=[],s=this.getAncestor(n,e.getLength()-1);return e.startsWith("//*")&&t.push(new XPath("//"+s.tagName.toLowerCase()+e.substring(3))),t}transfAddId(e,s){const t=[],n=this.getAncestor(s,e.getLength()-1);if(n.id&&!e.headHasAnyPredicates()){const s=new XPath(e.getValue());s.addPredicateToHead(`[@id='${n.id}']`),t.push(s)}return t}transfAddText(e,s){const t=[],n=this.getAncestor(s,e.getLength()-1);if(n.textContent&&!e.headHasPositionPredicate()&&!e.headHasTextPredicate()){const s=new XPath(e.getValue());s.addPredicateToHead(`[contains(text(),'${n.textContent}')]`),t.push(s)}return t}transfAddAttribute(e,s){const t=[],n=this.getAncestor(s,e.getLength()-1);if(!e.headHasAnyPredicates()){for(const s of this.attributePriorizationList)for(const o of n.attributes)if(o.name===s){const n=new XPath(e.getValue());n.addPredicateToHead(`[@${o.name}='${o.value}']`),t.push(n);break}for(const s of n.attributes)if(!this.attributeBlackList.includes(s.name)&&!this.attributePriorizationList.includes(s.name)){const n=new XPath(e.getValue());n.addPredicateToHead(`[@${s.name}='${s.value}']`),t.push(n)}}return t}transfAddAttributeSet(e,n){const t=[],s=this.getAncestor(n,e.getLength()-1);if(!e.headHasAnyPredicates()){this.attributePriorizationList.unshift("id");let o=[...s.attributes];o=o.filter(e=>!this.attributeBlackList.includes(e.name));let n=this.generatePowerSet(o);n=n.filter(e=>e.length>=2);for(const e of n)e.sort(this.elementCompareFunction.bind(this));n.sort((e,t)=>{if(e.length<t.length)return-1;if(e.length>t.length)return 1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return this.elementCompareFunction(e[n],t[n]);return 0}),this.attributePriorizationList.shift();for(const s of n){let o=`[@${s[0].name}='${s[0].value}'`;for(let e=1;e<s.length;e++)o+=` and @${s[e].name}='${s[e].value}'`;o+="]";const i=new XPath(e.getValue());i.addPredicateToHead(o),t.push(i)}}return t}transfAddPosition(t,s){const n=[],e=this.getAncestor(s,t.getLength()-1);if(!t.headHasPositionPredicate()){let s=1;if(t.startsWith("//*"))s=Array.from(e.parentNode.children).indexOf(e)+1;else for(const t of e.parentNode.children){if(e===t)break;e.tagName===t.tagName&&s++}const o=new XPath(t.getValue());o.addPredicateToHead(`[${s}]`),n.push(o)}return n}transfAddLevel(e,n){const t=[];return e.getLength()-1<this.getAncestorCount(n)&&t.push(new XPath("//*"+e.substring(1))),t}generatePowerSet(e){return e.reduce((e,t)=>e.concat(e.map(e=>[t,...e])),[[]])}elementCompareFunction(e,t){for(const n of this.attributePriorizationList){if(n===e.name)return-1;if(n===t.name)return 1}return 0}getAncestor(t,n){let e=t;for(let t=0;t<n;t++)e=e.parentElement;return e}getAncestorCount(e){let t=0;for(;e.parentElement;)e=e.parentElement,t++;return t}}exports.RobulaPlus=RobulaPlus;class XPath{constructor(e){this.value=e}getValue(){return this.value}startsWith(e){return this.value.startsWith(e)}substring(e){return this.value.substring(e)}headHasAnyPredicates(){return this.value.split("/")[2].includes("[")}headHasPositionPredicate(){const e=this.value.split("/"),t=new RegExp("[[0-9]]");return e[2].includes("position()")||e[2].includes("last()")||t.test(e[2])}headHasTextPredicate(){return this.value.split("/")[2].includes("text()")}addPredicateToHead(t){const e=this.value.split("/");e[2]+=t,this.value=e.join("/")}getLength(){const t=this.value.split("/");let e=0;for(const n of t)n&&e++;return e}}exports.XPath=XPath;class RobulaPlusOptions{constructor(){this.attributePriorizationList=["name","class","title","alt","value"],this.attributeBlackList=["href","src","onclick","onload","tabindex","width","height","style","size","maxlength"]}}exports.RobulaPlusOptions=RobulaPlusOptions